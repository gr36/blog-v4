<div class="post-meta">
<div>Reply via:</div>

<div class="leave-reply press" id="showForm">
    <i class="fa-solid fa-comment"></i> Leave Reply
  </div>
<div class="like-button press" id="likeButton" data-permalink="{{ .Title | urlize }}">
<i class="fa-solid fa-thumbs-up"></i> Like <span class="likeCount">0</span>
</div>
 <script>
        document.addEventListener('DOMContentLoaded', () => {
            const db = firebase.firestore();

            // Function to fetch the current like count from Firestore
            const fetchLikeCount = (permalink, likeCountElement) => {
                if (!permalink || !likeCountElement) {
                    console.error("Permalink or likeCountElement is empty");
                    return;
                }
                const docRef = db.collection('likes').doc(permalink);
                docRef.get().then((doc) => {
                    if (doc.exists) {
                        likeCountElement.innerText = doc.data().count;
                    } else {
                        docRef.set({ count: 0 });
                    }
                }).catch((error) => {
                    console.error("Error getting document:", error);
                });
            };

            // Function to handle like button click
            const handleLikeClick = (event) => {
                const button = event.currentTarget;
                const permalink = button.getAttribute('data-permalink');
                const likeCountElement = button.querySelector('.likeCount');

                if (!permalink || !likeCountElement) {
                    console.error("Permalink or likeCountElement is empty");
                    return;
                }

                if (localStorage.getItem(`liked_${permalink}`) !== 'true') {
                    const docRef = db.collection('likes').doc(permalink);
                    docRef.get().then((doc) => {
                        let newCount;
                        if (doc.exists) {
                            newCount = doc.data().count + 1;
                            return docRef.update({ count: newCount }).then(() => newCount);
                        } else {
                            newCount = 1;
                            return docRef.set({ count: newCount }).then(() => newCount);
                        }
                    }).then((newCount) => {
                        likeCountElement.innerText = newCount;
                        localStorage.setItem(`liked_${permalink}`, 'true'); // Mark as liked
                        button.classList.add('disabled'); // Change the button color
                    }).catch((error) => {
                        console.error("Transaction failed:", error);
                    });
                } else {
                    console.log("User already liked this post."); // Debug log
                }
            };

            // Function to check if the user has already liked a post
            const checkIfLiked = (permalink, button) => {
                if (localStorage.getItem(`liked_${permalink}`) === 'true') {
                    button.classList.add('disabled'); // Change the button color
                }
            };

            // Initialize like buttons
            document.querySelectorAll('.like-button').forEach(button => {
                const permalink = button.getAttribute('data-permalink');
                const likeCountElement = button.querySelector('.likeCount');
                if (permalink && likeCountElement) {
                    fetchLikeCount(permalink, likeCountElement);
                    checkIfLiked(permalink, button);
                    button.addEventListener('click', handleLikeClick);
                } else {
                    console.error("Permalink or likeCountElement is missing on a like button");
                }
            });
        });
    </script>
    </script>

<div class="social-reply press">
    <i class="fa-brands fa-microblog"></i><a href="https://micro.blog/gregmorris/" class="conversation-{{ .Title | urlize }}"> Micro.blog</a>
<script>
// Function to fetch the homepage URL and update the link
function updateHomepageLink() {
  fetch('https://micro.blog/conversation.js?format=jsonfeed&url={{ .Permalink }}')
    .then(response => response.json())
    .then(data => {
      const linkElement = document.querySelector('a.conversation-{{ .Title | urlize }}');
      if (data.home_page_url) {
        // If home_page_url exists, update the link's href
        linkElement.href = data.home_page_url;
      }
    });
}

// Call the function to update the link
document.addEventListener('DOMContentLoaded', updateHomepageLink);

</script>
  </div>
{{ with .Params.mastodon.id }}
    <div class="social-reply press">
            <a href="https://{{ $.Params.mastodon.hostname }}/@{{ $.Params.mastodon.username }}/{{ .Params.mastodon.id }}"><i class="fa-brands fa-mastodon"></i> Mastodon</a>
    </div>
{{ end }}

{{ with .Params.threads.url }}
    <div class="social-reply press">
            <a href="{{ $.Params.threads.url }}"><i class="fa-brands fa-threads"></i> Threads</a>
    </div>
{{ end }}
{{ with .Params.bluesky.link }}
    <div class="social-reply press">
            <a href="{{ $.Params.bluesky.link }}"><i class="fa-brands fa-bluesky"></i> BlueSky</a>
    </div>
    {{ end }}

  <div class="email-replay press">
   {{ partial "reply-by-email.html" . }}
  </div>
<div class="support-reply press"><a href="https://www.buymeacoffee.com/gregmorris">
    <i class="fa-solid fa-mug-saucer"></i> Support Me</a>
  </div>
</div>